name: Build and Release

on:
  workflow_dispatch:
    inputs:
      force:
        description: "Force build and release even if version matches"
        type: boolean
        default: false
  schedule:
    - cron: "0 3 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            .cache/shiru-flatpak
            .github/release-cache
          key: shiru-flatpak-${{ runner.os }}-${{ github.ref_name }}
          restore-keys: |
            shiru-flatpak-${{ runner.os }}-

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder curl python3
          flatpak remote-add --if-not-exists --user flathub https://flathub.org/repo/flathub.flatpakrepo

      - name: Check upstream version
        id: check
        run: |
          set -e
          mkdir -p .github/release-cache
          RELEASE_JSON=".github/release-cache/latest.json"
          RELEASE_ETAG=".github/release-cache/etag.txt"
          HEADERS_TMP="$(mktemp)"
          BODY_TMP="$(mktemp)"
          ETAG_HEADER=""
          if [ -f "$RELEASE_ETAG" ]; then
            ETAG_HEADER="$(cat "$RELEASE_ETAG")"
          fi

          HTTP_CODE="$(curl -sS -D "$HEADERS_TMP" -o "$BODY_TMP" -H "If-None-Match: ${ETAG_HEADER}" https://api.github.com/repos/RockinChaos/Shiru/releases/latest -w "%{http_code}")"

          case "$HTTP_CODE" in
            200)
              mv "$BODY_TMP" "$RELEASE_JSON"
              awk 'BEGIN{IGNORECASE=1} /^etag:/ {print $2}' "$HEADERS_TMP" | tr -d '\r' > "$RELEASE_ETAG"
              ;;
            304)
              if [ -f "$RELEASE_JSON" ]; then
                rm -f "$BODY_TMP"
              else
                echo "No cached release data for 304 response."
                exit 1
              fi
              ;;
            403|429)
              if [ -f "$RELEASE_JSON" ]; then
                echo "Rate-limited; using cached release data."
                rm -f "$BODY_TMP"
              else
                echo "Rate-limited and no cached data."
                exit 1
              fi
              ;;
            *)
              if [ -f "$RELEASE_JSON" ]; then
                echo "API error ${HTTP_CODE}; using cached release data."
                rm -f "$BODY_TMP"
              else
                echo "Failed to fetch release data (HTTP ${HTTP_CODE})."
                exit 1
              fi
              ;;
          esac
          rm -f "$HEADERS_TMP"

          python3 - << 'PY'
          import json
          import os
          
          with open('.github/release-cache/latest.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          
          latest = data.get('tag_name', '').strip()
          body = (data.get('body') or '').strip()
          
          with open('VERSION', 'r', encoding='utf-8') as f:
              current = f.read().strip()
          
          force = os.environ.get('FORCE', 'false').lower() == 'true'
          should_build = force or (latest and latest != current)
          
          notes = [
              '# Shiru Flatpak Release',
              '',
              f'Custom message: Repackaged upstream {latest} into Flatpak with automated caching and version-aware updates.',
              '',
              'Upstream notes:',
              body or '(no upstream notes found)',
              ''
          ]
          
          with open('RELEASE_NOTES.md', 'w', encoding='utf-8') as f:
              f.write('\n'.join(notes))
          
          print(f'latest={latest}')
          print(f'current={current}')
          print(f'should_build={should_build}')
          
          with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as f:
              f.write(f"tag={latest}\n")
              f.write(f"should_build={'true' if should_build else 'false'}\n")
          PY
        env:
          FORCE: ${{ inputs.force }}

      - name: Stop if no update
        if: steps.check.outputs.should_build != 'true'
        run: echo "No new upstream version; skipping build."

      - name: Build Flatpak
        if: steps.check.outputs.should_build == 'true'
        env:
          CACHE_ROOT: ${{ github.workspace }}/.cache/shiru-flatpak
        run: |
          ./flatpak-build.sh --clean --update --force-install --repo "${GITHUB_WORKSPACE}/flatpak-repo"

      - name: Create bundle
        if: steps.check.outputs.should_build == 'true'
        run: |
          flatpak build-bundle "${GITHUB_WORKSPACE}/flatpak-repo" shiru.flatpak com.github.rockinchaos.shiru
          sha256sum shiru.flatpak > shiru.flatpak.sha256

      - name: Update VERSION
        if: steps.check.outputs.should_build == 'true'
        run: |
          echo "${{ steps.check.outputs.tag }}" > VERSION
          git config user.name "shiru-flatpak-bot"
          git config user.email "shiru-flatpak-bot@users.noreply.github.com"
          git add VERSION
          git commit -m "chore: bump VERSION to ${{ steps.check.outputs.tag }}" || true
          git push

      - name: Create GitHub release
        if: steps.check.outputs.should_build == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.check.outputs.tag }}
          name: Shiru Flatpak ${{ steps.check.outputs.tag }}
          body_path: RELEASE_NOTES.md
          files: |
            shiru.flatpak
            shiru.flatpak.sha256
