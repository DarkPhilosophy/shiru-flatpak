name: Build and Release

on:
  workflow_dispatch:
    inputs:
      force:
        description: "Force build and release even if version matches"
        type: boolean
        default: false
  schedule:
    - cron: "0 3 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            .cache/shiru-flatpak
            .github/release-cache
          key: shiru-flatpak-${{ runner.os }}-${{ github.ref_name }}
          restore-keys: |
            shiru-flatpak-${{ runner.os }}-

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder curl python3
          flatpak remote-add --if-not-exists --user flathub https://flathub.org/repo/flathub.flatpakrepo
      - name: Install Flatpak runtimes
        run: |
          flatpak install --user -y flathub org.freedesktop.Platform//25.08 org.freedesktop.Sdk//25.08

      - name: Check upstream version
        id: check
        run: |
          set -e
          mkdir -p .github/release-cache
          RELEASE_JSON=".github/release-cache/latest.json"
          RELEASE_ETAG=".github/release-cache/etag.txt"
          HEADERS_TMP="$(mktemp)"
          BODY_TMP="$(mktemp)"
          ETAG_HEADER=""
          if [ -f "$RELEASE_ETAG" ]; then
            ETAG_HEADER="$(cat "$RELEASE_ETAG")"
          fi

          HTTP_CODE="$(curl -sS -D "$HEADERS_TMP" -o "$BODY_TMP" -H "If-None-Match: ${ETAG_HEADER}" https://api.github.com/repos/RockinChaos/Shiru/releases/latest -w "%{http_code}")"

          case "$HTTP_CODE" in
            200)
              mv "$BODY_TMP" "$RELEASE_JSON"
              awk 'BEGIN{IGNORECASE=1} /^etag:/ {print $2}' "$HEADERS_TMP" | tr -d '\r' > "$RELEASE_ETAG"
              ;;
            304)
              if [ -f "$RELEASE_JSON" ]; then
                rm -f "$BODY_TMP"
              else
                echo "No cached release data for 304 response."
                exit 1
              fi
              ;;
            403|429)
              if [ -f "$RELEASE_JSON" ]; then
                echo "Rate-limited; using cached release data."
                rm -f "$BODY_TMP"
              else
                echo "Rate-limited and no cached data."
                exit 1
              fi
              ;;
            *)
              if [ -f "$RELEASE_JSON" ]; then
                echo "API error ${HTTP_CODE}; using cached release data."
                rm -f "$BODY_TMP"
              else
                echo "Failed to fetch release data (HTTP ${HTTP_CODE})."
                exit 1
              fi
              ;;
          esac
          rm -f "$HEADERS_TMP"

          python3 -c $'import json,os\nfrom pathlib import Path\nwith open(".github/release-cache/latest.json","r",encoding="utf-8") as f:\n    data=json.load(f)\nlatest=(data.get("tag_name") or "").strip()\nbody=(data.get("body") or "").strip()\nforce=os.environ.get("FORCE","false").lower()=="true"\nupstream_file=Path("UPSTREAM_VERSION")\nrecorded=upstream_file.read_text(encoding="utf-8").strip() if upstream_file.exists() else ""\nshould_build=force or (not recorded) or (latest and latest != recorded)\nversion_file=Path("VERSION")\nproject_version=version_file.read_text(encoding="utf-8").strip() if version_file.exists() else "unknown"\nmanifest_file=Path(".flatpak-manifest.yaml")\nmanifest_text=manifest_file.read_text(encoding="utf-8").splitlines() if manifest_file.exists() else []\napp_id=\"\"\nruntime=\"\"\nruntime_version=\"\"\nsdk=\"\"\nfor line in manifest_text:\n    if line.startswith(\"app-id:\"):\n        app_id=line.split(\":\",1)[1].strip()\n    elif line.startswith(\"runtime:\"):\n        runtime=line.split(\":\",1)[1].strip()\n    elif line.startswith(\"runtime-version:\"):\n        runtime_version=line.split(\":\",1)[1].strip().strip(\"\\\"\\'\")\n    elif line.startswith(\"sdk:\"):\n        sdk=line.split(\":\",1)[1].strip()\nnotes=[\n    \"# Shiru Flatpak Release\",\n    \"\",\n    \"Project version: {}\".format(project_version),\n    \"Upstream version: {}\".format(latest),\n    \"App ID: {}\".format(app_id or \"unknown\"),\n    \"Runtime: {}//{}\".format(runtime or \"unknown\", runtime_version or \"unknown\"),\n    \"SDK: {}//{}\".format(sdk or \"unknown\", runtime_version or \"unknown\"),\n    \"\",\n    \"Packaging details:\",\n    \"- Repackaged upstream .deb into Flatpak.\",\n    \"- Build uses cached extraction and version-aware update logic.\",\n    \"- Install step is skipped in CI (build-only).\",\n    \"\",\n    \"Upstream notes:\",\n    body or \"(no upstream notes found)\",\n    \"\"\n]\nwith open(\"RELEASE_NOTES.md\",\"w\",encoding=\"utf-8\") as f:\n    f.write(\"\\n\".join(notes))\nprint(\"latest={}\".format(latest))\nprint(\"recorded_upstream={}\".format(recorded or \"(none)\"))\nprint(\"should_build={}\".format(should_build))\nwith open(os.environ[\"GITHUB_OUTPUT\"],\"a\",encoding=\"utf-8\") as f:\n    f.write(\"tag={}\\n\".format(latest))\n    f.write(\"should_build={}\\n\".format(\"true\" if should_build else \"false\"))'
        env:
          FORCE: ${{ inputs.force }}

      - name: Stop if no update
        if: steps.check.outputs.should_build != 'true'
        run: echo "No new upstream version; skipping build."

      - name: Build Flatpak
        if: steps.check.outputs.should_build == 'true'
        env:
          CACHE_ROOT: ${{ github.workspace }}/.cache/shiru-flatpak
        run: |
          ./flatpak-build.sh --clean --update --skip-install --repo "${GITHUB_WORKSPACE}/flatpak-repo"

      - name: Create bundle
        if: steps.check.outputs.should_build == 'true'
        run: |
          flatpak build-bundle "${GITHUB_WORKSPACE}/flatpak-repo" shiru.flatpak com.github.rockinchaos.shiru
          sha256sum shiru.flatpak > shiru.flatpak.sha256

      - name: Update UPSTREAM_VERSION
        if: steps.check.outputs.should_build == 'true'
        run: |
          echo "${{ steps.check.outputs.tag }}" > UPSTREAM_VERSION
          git config user.name "shiru-flatpak-bot"
          git config user.email "shiru-flatpak-bot@users.noreply.github.com"
          git add UPSTREAM_VERSION
          git commit -m "chore: bump UPSTREAM_VERSION to ${{ steps.check.outputs.tag }}" || true
          git push

      - name: Create GitHub release
        if: steps.check.outputs.should_build == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.check.outputs.tag }}
          name: Shiru Flatpak ${{ steps.check.outputs.tag }}
          body_path: RELEASE_NOTES.md
          files: |
            shiru.flatpak
            shiru.flatpak.sha256
