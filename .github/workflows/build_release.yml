name: Build and Release

on:
  workflow_dispatch:
    inputs:
      force:
        description: "Force build and release even if version matches"
        type: boolean
        default: false
  schedule:
    - cron: "0 3 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            .cache/shiru-flatpak
            .github/release-cache
          key: shiru-flatpak-${{ runner.os }}-${{ github.ref_name }}
          restore-keys: |
            shiru-flatpak-${{ runner.os }}-

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder curl python3
          flatpak remote-add --if-not-exists --user flathub https://flathub.org/repo/flathub.flatpakrepo
      - name: Install Flatpak runtimes
        run: |
          flatpak install --user -y flathub org.freedesktop.Platform//25.08 org.freedesktop.Sdk//25.08

      - name: Build Flatpak (Auto-Check)
        id: build
        env:
          FORCE: ${{ inputs.force }}
          CACHE_ROOT: ${{ github.workspace }}/.cache/shiru-flatpak
        run: |
          ./flatpak-build.sh --check-upstream --clean --skip-install --repo "${GITHUB_WORKSPACE}/flatpak-repo"

      - name: Create bundle
        if: steps.build.outputs.should_build == 'true'
        run: |
          flatpak build-bundle "${GITHUB_WORKSPACE}/flatpak-repo" shiru.flatpak com.github.rockinchaos.shiru
          sha256sum shiru.flatpak > shiru.flatpak.sha256

      - name: Create GitHub release
        if: steps.build.outputs.should_build == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.build.outputs.tag }}
          name: Shiru Flatpak ${{ steps.build.outputs.tag }}
          body_path: RELEASE_NOTES.md
          files: |
            shiru.flatpak
            shiru.flatpak.sha256

      - name: Commit version and changelog updates
        if: steps.build.outputs.should_build == 'true'
        run: |
          git config user.name "shiru-flatpak-bot"
          git config user.email "shiru-flatpak-bot@users.noreply.github.com"
          git add UPSTREAM_VERSION .github/CHANGELOG.md
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "chore: update to upstream version ${{ steps.build.outputs.tag }}"
          git fetch origin main
          git rebase origin/main
          git push
